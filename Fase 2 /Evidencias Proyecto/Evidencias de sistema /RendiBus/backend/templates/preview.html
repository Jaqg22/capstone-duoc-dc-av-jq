<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista Previa - RendiBus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003E84, #002856);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            margin-top: 2rem;
        }

        .header {
            background: linear-gradient(135deg, #003E84, #002856);
            color: white;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .content {
            padding: 2rem;
            text-align: center;
        }

        #previewImage {
            max-width: 100%;
            max-height: 50vh;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 62, 132, 0.3);
            margin-bottom: 1.5rem;
            border: 2px solid #F5C303;
        }

        .file-info {
            background: #E8F4FD;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .file-info h4 {
            color: #27ae60;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .file-info p {
            color: #666;
            font-size: 0.9rem;
            margin: 0.3rem 0;
        }

        .buttons {
            display: flex;
            gap: 1rem;
            flex-direction: column;
        }

        button {
            padding: 1rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #003E84, #002856);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 62, 132, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-rotate {
            background: #F5C303;
            color: #003E84;
        }

        .btn-rotate:hover {
            background: #d4a803;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #856404;
            font-size: 0.9rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid rgba(0, 62, 132, 0.3);
            border-top: 4px solid #F5C303;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin-top: 1rem;
            }
            
            .header {
                padding: 1rem;
                font-size: 1.1rem;
            }
            
            .content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            üîç Vista Previa - Confirmar Imagen
        </div>
        
        <div class="content" id="mainContent">
            <img id="previewImage" alt="Vista previa">
            
            <div class="file-info">
                <h4>üìÅ Detalles del Archivo:</h4>
                <p><strong>Nombre:</strong> <span id="fileName"></span></p>
                <p><strong>Tama√±o:</strong> <span id="fileSize"></span></p>
            </div>
            
            <div class="warning">
                üí° Aseg√∫rate de que el documento sea legible y est√© bien iluminado
            </div>
            
            <div class="buttons">
                <button class="btn-rotate" onclick="rotateImage()">üîÑ Rotar</button>
                <button class="btn-primary" onclick="uploadImage()">üöÄ Enviar Imagen</button>
                <button class="btn-secondary" onclick="goBack()">‚Üê Tomar Otra</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: #003E84; font-weight: 600;">Procesando imagen...</p>
            <p style="color: #666; font-size: 0.9rem;">Esto puede tomar unos segundos</p>
        </div>
    </div>

    <script>
        let imageFile = null;
        let rotation = 0;

        // Cargar imagen desde localStorage
        window.addEventListener('DOMContentLoaded', function() {
            const imageData = localStorage.getItem('tempImageData');
            const imageName = localStorage.getItem('tempImageName');
            const imageSize = localStorage.getItem('tempImageSize');
            
            if (!imageData || !imageName) {
                alert('No hay imagen para mostrar');
                window.location.href = '/';
                return;
            }
            
            // Mostrar imagen
            document.getElementById('previewImage').src = imageData;
            document.getElementById('fileName').textContent = imageName;
            document.getElementById('fileSize').textContent = formatFileSize(parseInt(imageSize));
            
            // Convertir dataURL a File
            fetch(imageData)
                .then(res => res.blob())
                .then(blob => {
                    imageFile = new File([blob], imageName, { type: blob.type });
                });
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function rotateImage() {
            rotation = (rotation + 90) % 360;
            document.getElementById('previewImage').style.transform = `rotate(${rotation}deg)`;
        }

        function goBack() {
            // Limpiar localStorage
            localStorage.removeItem('tempImageData');
            localStorage.removeItem('tempImageName');
            localStorage.removeItem('tempImageSize');
            
            // Volver a la p√°gina principal
            window.location.href = '/';
        }

        async function uploadImage() {
            if (!imageFile) {
                alert('Error: No se pudo cargar la imagen');
                return;
            }
            
            // Mostrar loading
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Comprimir imagen
                const compressedFile = await compressImage(imageFile, 2, 1920);
                
                // Crear FormData
                const formData = new FormData();
                formData.append('imagen', compressedFile);
                
                // Obtener token CSRF
                const csrfToken = getCsrfToken();
                
                // Enviar a Azure OCR
                const response = await fetch('/api/upload_imagen/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.planilla_id) {
                    // Guardar planilla_id para que manual.html lo procese
                    localStorage.setItem('planillaIdPendiente', data.planilla_id);
                    localStorage.setItem('imagenNombre', imageFile.name);
                    localStorage.setItem('tiempoOCR', Date.now().toString());
                    
                    // Limpiar datos temporales
                    localStorage.removeItem('tempImageData');
                    localStorage.removeItem('tempImageName');
                    localStorage.removeItem('tempImageSize');
                    
                    // Redirigir a manual
                    window.location.href = '/manual/';
                } else {
                    throw new Error(data.error || 'Error al procesar la imagen');
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la imagen: ' + error.message);
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function compressImage(file, maxSizeMB = 2, maxWidthOrHeight = 1920) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidthOrHeight) {
                                height *= maxWidthOrHeight / width;
                                width = maxWidthOrHeight;
                            }
                        } else {
                            if (height > maxWidthOrHeight) {
                                width *= maxWidthOrHeight / height;
                                height = maxWidthOrHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            resolve(compressedFile);
                        }, 'image/jpeg', 0.85);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return '';
        }
    </script>
</body>
</html>
